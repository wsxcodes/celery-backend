{% extends 'base.html' %}

{% block meta %}
{% endblock %}

{% block content %}

  <div class="max-w-5xl mx-auto px-4 py-8">

    <!-- Header -->
    {% include "elements/header.html" %}

    <!-- Drag and Drop Area -->
    <div id="dropZone" class="w-full max-w-lg mx-auto p-8 bg-gray-800 rounded-xl text-center border-2 border-dashed border-gray-600 hover:border-blue-500 transition-colors">
      <input type="file" id="fileInput" class="hidden" accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg,.webp,.gif" multiple />
      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
      </svg>
      <p class="mt-4 text-xl font-semibold text-white">Drag & Drop your documents here</p>
      <p class="mt-2 text-sm text-gray-400">Or click to select files</p>
      <p class="mt-2 text-xs text-gray-500">
        Supported formats: PDF, DOC, DOCX, TXT,
        <br/>
        as well as common image formats like PNG, JPEG, WEBP, and GIF.
      </p>
      <div id="uploadStatus" class="mt-4 text-sm text-gray-400 hidden"></div>
    </div>

    {% if categorized_documents %}
      {% for category_group in categorized_documents %}
        <div class="mb-12">
          <h2 class="text-2xl font-bold text-white mb-6">{{ category_group.category if category_group.category else "" }}</h2>
          <div class="space-y-4">

              <ul>
                {% for doc in category_group.documents %}
                  <li>analysis_status: {{ doc.analysis_status }}</li>
                  <li>file_size: {{ doc.file_size }}</li>
                  <li>uploaded_at: {{ doc.uploaded_at }}</li>
                  <li>ai_alert: {{ doc.ai_alert }}</li>
                {% endfor %}
              </ul>
              <br/>
              <br/>

              {% for doc in category_group.documents %}
                  <a href="/1" class="file-item p-4 bg-gray-800 rounded-xl flex items-center justify-between no-underline hover:no-underline">
                    <div class="flex items-center space-x-4">
                    <svg class="h-8 w-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <div>
                          <p class="text-base font-medium text-white"> {{customer.id}} {{ doc.filename }}</p>

                          {% if doc.ai_summary_short %}
                            <p class="text-sm text-gray-400">{{ doc.ai_summary_short }}</p>
                          {% endif %}


                          <div class="flex items-center space-x-2 mt-1 text-xs">

                          {% if doc.analysis_status == "processed" %}
                            <span class="flex items-center text-green-400">
                              <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                              </svg>
                              {{ doc.analysis_status|title}}
                            </span>
                          {% endif %}
                          {% if doc.analysis_status == "pending" %}
                            <span class="flex items-center text-yellow-400">
                              <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                              </svg>
                              {{ doc.analysis_status|title}}
                            </span>
                          {% endif %}
                        </span>
                        <span class="text-gray-500">{{doc.file_size_human}}</span>
                        <span class="text-gray-500">{{doc.uploaded_at_human}}</span>
                        </div>
                    </div>
                    </div>
                    <div class="flex items-center space-x-2">
                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-600 text-white">Insights Available XXX</span>
                    <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                    </svg>
                    </div>
                  </a>
              {% endfor %}

              {% if not category_group.category and categorized_documents|length > 1 %}
              <br/>
              <hr/>
              {% endif %}

          </div>
        </div>
      {% endfor %}
    {% endif %}

    {% if categorized_documents %}

        <!-- Category: Financial Reports -->
         <div class="mb-12">
            <h2 class="text-2xl font-bold text-white mb-6">Financial Reports</h2>
            <div class="space-y-4">

              <!-- File 1 -->
              <a href="/1" class="file-item p-4 bg-gray-800 rounded-xl flex items-center justify-between no-underline hover:no-underline">
                  <div class="flex items-center space-x-4">
                  <svg class="h-8 w-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                  <div>
                        <p class="text-base font-medium text-white">Q1_2025_Report.pdf</p>
                        <p class="text-sm text-gray-400">Quarterly financial performance overview for Q1 2025.</p>
                      <div class="flex items-center space-x-2 mt-1 text-xs">
                      <span class="flex items-center text-green-400">
                          <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                          </svg>
                          Processed
                      </span>
                      <span class="text-gray-500">381.89 KB</span>
                      <span class="text-gray-500">Today at 16:43</span>
                      </div>
                  </div>
                  </div>
                  <div class="flex items-center space-x-2">
                  <span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-600 text-white">Insights Available</span>
                  <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                  </svg>
                  </div>
              </a>
              <!-- File 2 -->
              <a href="/1" class="file-item p-4 bg-gray-800 rounded-xl flex items-center justify-between no-underline hover:no-underline">
                  <div class="flex items-center space-x-4">
                  <svg class="h-8 w-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                  <div>
                        <p class="text-base font-medium text-white">Budget_Proposal.docx</p>
                        <p class="text-sm text-gray-400">Proposed budget allocations for FY 2026.</p>
                      <div class="flex items-center space-x-2 mt-1 text-xs">
                      <span class="flex items-center text-yellow-400">
                          <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                          </svg>
                          Pending
                      </span>
                      <span class="text-gray-500">245.67 KB</span>
                      <span class="text-gray-500">Today at 14:22</span>
                      </div>
                  </div>
                  </div>
                  <div class="flex items-center space-x-2">
                  <span class="px-2 py-1 rounded-full text-xs font-medium bg-red-600 text-white">Action Required</span>
                  <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                  </svg>
                  </div>
              </a>
            </div>
        </div>

        <!-- Category: Contracts -->
        <div class="mb-12">
            <h2 class="text-2xl font-bold text-white mb-6">Contracts</h2>
            <div class="space-y-4">
              <!-- File 1 -->
              <a href="/1" class="file-item p-4 bg-gray-800 rounded-xl flex items-center justify-between no-underline hover:no-underline">
                  <div class="flex items-center space-x-4">
                  <svg class="h-8 w-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                  <div>
                        <p class="text-base font-medium text-white">Vendor_Agreement.pdf</p>
                        <p class="text-sm text-gray-400">Agreement with vendor for supply chain services.</p>
                      <div class="flex items-center space-x-2 mt-1 text-xs">
                      <span class="flex items-center text-green-400">
                          <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                          </svg>
                          Processed
                      </span>
                      <span class="text-gray-500">512.34 KB</span>
                      <span class="text-gray-500">Yesterday at 09:15</span>
                      </div>
                  </div>
                  </div>
                  <div class="flex items-center space-x-2">
                  <span class="px-2 py-1 rounded-full text-xs font-medium bg-orange-600 text-white">Alert</span>
                  <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                  </svg>
                  </div>
              </a>
            </div>
        </div>
        </div>

    {% else %}

        <!-- No files? Show category cloud -->
        <div class="mt-12 text-center">
            <h2 class="text-2xl font-semibold text-white mb-3">Intelligent Oversight for Every Corner of Your Life</h2>
            <p class="text-gray-300 max-w-xl mx-auto mb-6">
            Never miss an expiring contract, overlooked liability, or outdated insurance again. Our AI audits, summarizes, and keeps every document category—from <strong>Identity</strong> to <strong>Miscellaneous</strong>—in check.
            </p>
            <br/>
            <div class="flex flex-wrap justify-center gap-3 text-sm">
            <span class="px-3 py-1 rounded-full bg-indigo-700 text-white">Identity</span>
            <span class="px-3 py-1 rounded-full bg-purple-700 text-white">Family</span>
            <span class="px-3 py-1 rounded-full bg-blue-700 text-white">Financial</span>
            <span class="px-3 py-1 rounded-full bg-green-700 text-white">Real Estate</span>
            <span class="px-3 py-1 rounded-full bg-yellow-700 text-black">Insurance</span>
            <span class="px-3 py-1 rounded-full bg-red-600 text-white">Liabilities</span>
            <span class="px-3 py-1 rounded-full bg-pink-700 text-white">Digital Accounts</span>
            <span class="px-3 py-1 rounded-full bg-gray-600 text-white">Personal Belongings</span>
            <span class="px-3 py-1 rounded-full bg-orange-700 text-white">Businesses</span>
            </div>
        </div>

    {% endif %}

    <!-- Footer with Customer ID and Language Selector -->
    <footer class="mt-8 text-center text-sm text-green-300">
      <p>Customer ID: <strong>{{session_id}}</strong></p>
      <p>Output language:
        <span class="text-gray-400">{{output_language}}</span>
      </p>
    </footer>

  </div>

{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const uploadStatus = document.getElementById('uploadStatus');
    const clientId = '{{session_id}}';
    const endpoint = `/api/v1/document/add/${clientId}`;

    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    // Highlight drop zone on drag
    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => {
        dropZone.classList.add('border-blue-500', 'bg-gray-700');
      }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => {
        dropZone.classList.remove('border-blue-500', 'bg-gray-700');
      }, false);
    });

    // Handle dropped files
    dropZone.addEventListener('drop', (e) => {
      const files = e.dataTransfer.files;
      handleFiles(files);
    });

    // Handle click to select files
    dropZone.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', () => {
      handleFiles(fileInput.files);
      fileInput.value = ''; // Reset input
    });

    function handleFiles(files) {
      const allowedTypes = [
        'application/pdf',
        'application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'text/plain',
        'image/png',
        'image/jpeg',
        'image/webp',
        'image/gif'
      ];

      Array.from(files).forEach(file => {
        if (!allowedTypes.includes(file.type)) {
          showStatus(`File ${file.name} not supported.<br/>Please choose a supported file type.`, 'text-red-400', true);
          return;
        }

        uploadFile(file);
      });
    }

    function showStatus(message, className, isError = false) {
      // Create a new status message element
      const statusMessage = document.createElement('p');
      statusMessage.className = `text-sm ${className}`;

      // Use innerHTML for errors to support HTML tags like <br/>
      if (isError) {
        statusMessage.innerHTML = message;
      } else {
        statusMessage.textContent = message;
      }

      // Append the message to the uploadStatus container
      uploadStatus.appendChild(statusMessage);
      uploadStatus.classList.remove('hidden');

      // Non-error messages persist until cleared manually or new upload starts
      if (!isError && !message.includes('Uploading')) {
        setTimeout(() => {
          statusMessage.remove();
          if (!uploadStatus.hasChildNodes()) {
            uploadStatus.classList.add('hidden');
          }
        }, 5000);
      }
    }

    async function uploadFile(file) {
      const formData = new FormData();
      formData.append('file', file);

      // Clear existing messages when starting a new upload
      uploadStatus.innerHTML = '';
      uploadStatus.classList.add('hidden');

      const uploadingMessage = document.createElement('p');
      uploadingMessage.className = 'text-sm text-yellow-400';
      uploadingMessage.textContent = `Uploading ${file.name}...`;
      uploadStatus.appendChild(uploadingMessage);
      uploadStatus.classList.remove('hidden');

      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
          },
          body: formData,
        });

        // Remove the "Uploading" message immediately
        uploadingMessage.remove();
        if (!uploadStatus.hasChildNodes()) {
          uploadStatus.classList.add('hidden');
        }

        if (response.ok) {
          showStatus(`File ${file.name} uploaded successfully!`, 'text-green-400');
        } else {
          const error = await response.json();
          const errorMessage = error.detail || error.message || 'Unknown error';
          showStatus(`Failed to upload ${file.name}:<br/><b><font size=6>${errorMessage}</font></b>`, 'text-red-400', true);
        }
      } catch (error) {
        // Remove the "Uploading" message immediately
        uploadingMessage.remove();
        if (!uploadStatus.hasChildNodes()) {
          uploadStatus.classList.add('hidden');
        }

        showStatus(`Error uploading ${file.name}:<br/><b><font size=6>${error.message}</font></b>`, 'text-red-400', true);
      }
    }
  });
</script>
{% endblock %}
