{% extends 'base.html' %}

{% block title %}EtenryIQ - {{document.filename}}{% endblock %}

{% block meta %}{% endblock %}

{% block styles %}
  <style>
    .gradient-bg {
      background: linear-gradient(135deg, #1e3a8a, #3b82f6);
    }
    .section-card {
      transition: background-color 0.2s ease-in-out;
    }
    .section-card:hover {
      background-color: #2d3748;
    }
    .dropdown {
      position: relative;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #2d3748;
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 10;
      border-radius: 0.5rem;
      right: 0;
      top: 100%;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
    }
    .dropdown:hover .dropdown-content,
    .dropdown:focus-within .dropdown-content,
    .dropdown.active .dropdown-content {
      display: block;
      opacity: 1;
      visibility: visible;
    }
    .dropdown-item {
      padding: 0.5rem 1rem;
      color: #e5e7eb;
      cursor: pointer;
      display: block;
    }
    .dropdown-item:hover {
      background-color: #4b5563;
    }
    .dropdown-item a {
      color: inherit;
      text-decoration: none;
      display: block;
      width: 100%;
    }
    .alert-card {
      border-left: 4px solid;
    }
    .alert-card.action-required {
      border-color: #ef4444;
    }
    .alert-card.review-suggested {
      border-color: #f97316;
    }
    .alert-card {
      transition: transform 0.2s ease-in-out;
    }
    .alert-card:hover {
      transform: translateX(8px);
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 50;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background-color: #2d3748;
      padding: 1.5rem;
      border-radius: 0.5rem;
      width: 100%;
      max-width: 500px;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      cursor: pointer;
    }
    .timeline {
      position: relative;
      padding-left: 2.5rem;
    }
    .timeline-item {
      position: relative;
      margin-bottom: 1.5rem;
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -1.75rem;
      top: 0.5rem;
      width: 0.75rem;
      height: 0.75rem;
      background-color: #3b82f6;
      border-radius: 50%;
      z-index: 1;
    }
    .timeline-item:not(:last-child)::after {
      content: '';
      position: absolute;
      left: -1.625rem;
      top: 1.25rem;
      bottom: -1.5rem;
      width: 0.125rem;
      background-color: #4b5563;
    }
    .chat-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      margin: 0;
      padding: 1rem;
      background-color: #1f2937;
      border-top-left-radius: 0.5rem;
      border-top-right-radius: 0.5rem;
      box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.1);
      z-index: 100;
      transition: height 0.3s ease-in-out;
    }
    .chat-container.minimized {
      height: 50px;
      padding: 0.5rem 1rem;
    }
    .chat-container.maximized {
      height: 500px;
    }
    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
    }
    .chat-header:hover {
      background-color: #2d3748;
    }
    .chat-toggle {
      transition: transform 0.3s ease-in-out;
    }
    .chat-toggle.minimized {
      transform: rotate(180deg);
    }
    .chat-content {
      display: flex;
      flex-direction: column;
      height: calc(100% - 2.5rem);
      margin-top: 0.5rem;
      transition: opacity 0.3s ease-in-out;
    }
    .chat-container.minimized .chat-content {
      display: none;
    }
    .chat-input {
      display: flex;
      align-items: center;
      background-color: #374151;
      border-radius: 0.5rem;
      padding: 0.5rem;
      transition: box-shadow 0.2s ease-in-out;
    }
    .chat-input:focus-within {
      box-shadow: 0 0 0 2px #3b82f6;
    }
    .chat-input input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: #e5e7eb;
      font-size: 0.875rem;
      padding: 0.5rem;
    }
    .chat-input button {
      padding: 0.5rem 1rem;
      background-color: #3b82f6;
      color: white;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      font-weight: 500;
      transition: background-color 0.2s ease-in-out;
    }
    .chat-input button:hover {
      background-color: #2563eb;
    }
    .chat-dialog {
      flex: 1;
      overflow-y: auto;
      margin-top: 1rem;
      padding: 0.75rem;
      background-color: #2d3748;
      border-radius: 0.5rem;
    }
    .chat-dialog-question {
      display: flex;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }
    .chat-dialog-question svg {
      flex-shrink: 0;
      margin-right: 0.5rem;
      margin-top: 0.25rem;
    }
    .chat-dialog-question p {
      color: #e5e7eb;
      font-size: 0.875rem;
      font-weight: 500;
    }
    .chat-dialog-answer {
      display: flex;
      align-items: flex-start;
    }
    .chat-dialog-answer svg {
      flex-shrink: 0;
      margin-right: 0.5rem;
      margin-top: 0.25rem;
    }
    .chat-dialog-answer p {
      color: #d1d5db;
      font-size: 0.875rem;
    }
    @media (max-width: 640px) {
      .chat-container {
        padding: 0.5rem;
      }
      .chat-input input {
        font-size: 0.75rem;
      }
      .chat-input button {
        padding: 0.5rem;
        font-size: 0.75rem;
      }
      .chat-container.minimized {
        height: 40px;
      }
    }

    /* Full-Screen Document Modal */
    .document-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 100;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .document-modal-content {
      position: relative;
      max-width: 1200px;
      width: 90%;
      max-height: 90%;
      overflow: auto;
      border-radius: 0.5rem;
    }

    .document-modal-content img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 0.5rem;
    }

    .document-modal-close {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      cursor: pointer;
      background-color: #2d3748;
      border-radius: 50%;
      padding: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .document-modal-close svg {
      width: 1.5rem;
      height: 1.5rem;
      color: #e5e7eb;
    }

    .preview-container {
      overflow: hidden; /* Still useful to ensure no overflow */
    }

    .preview-image {
      width: 100%; /* Scale the image to the full width of the container */
      height: auto; /* Let the height adjust to maintain aspect ratio */
    }

    @media (max-width: 640px) {
      .document-modal-content {
        width: 95%;
        max-height: 85%;
      }

      .document-modal-close {
        top: 0.4rem;
        right: 0.4rem;
        padding: 0.3rem;
      }

      .document-modal-close svg {
        width: 1.2rem;
        height: 1.2rem;
      }
    }
    /* Subtle highlight for mapping links */
    .mapping-link {
      color: #60a5fa;
      text-decoration: underline dotted;
      background-color: rgba(59, 130, 246, 0.1);
      border-radius: 0.2rem;
      transition: background-color 0.2s ease-in-out;
    }
    .mapping-link:hover {
      background-color: rgba(59, 130, 246, 0.2);
    }
  </style>
{% endblock %}

{% block content %}
  <div class="max-w-6xl mx-auto px-4 py-8">
    <!-- Header -->
    {% include "elements/header.html" %}

    <header class="mb-10">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <svg class="h-10 w-10 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <div>
            <h1 class="text-3xl font-extrabold tracking-tight text-white">
              {{document.filename}}
            </h1>
            <div class="flex items-center space-x-3 mt-2 text-sm">
              <span class="px-3 py-1 bg-blue-600 text-white rounded-full">{{document.ai_category}}</span>
              <span class="px-3 py-1 bg-indigo-600 text-white rounded-full">{{document.ai_sub_category}}</span>
              <span class="text-gray-400 flex items-center">
                <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Uploaded {{document.uploaded_at}}
              </span>

              <!-- <font color="red">XXX expires</font>
              {% if document.ai_expires %}
                <span class="text-gray-400 flex items-center">
                  <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                  </svg>
                  Expires {{document.ai_expires}}
                </span>
              {% endif %} -->

            </div>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <div class="text-right">
            <p class="text-gray-400 text-sm">Health Score</p>
            <p class="text-2xl font-bold text-green-400">{{document.health_score}}%</p>
          </div>
          <button id="upload-new-version" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">Upload New Version</button>
          <div class="dropdown relative">
            <svg class="h-6 w-6 text-gray-400 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
            </svg>
            <div class="dropdown-content">
              <div class="dropdown-item" id="copy-link">Copy link</div>
              <div class="dropdown-item">
                <a href="/data/uploads/{{document.customer_id}}/{{document.filename|urlencode}}" download="{{document.filename|urlencode}}">Download</a>
              </div>
              <div class="dropdown-item print-item">Print</div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Upload Modal -->
    <div id="upload-modal" class="modal">
      <div class="modal-content">
        <svg id="close-modal" class="modal-close h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
        <h2 class="text-xl font-bold text-white mb-4">Upload New Document Version</h2>
        <form id="upload-form">
          <div class="mb-4">
            <label for="document-file" class="block text-sm font-medium text-gray-300">Select Document</label>
            <input type="file" id="document-file" accept=".pdf" class="mt-1 block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700" required>
          </div>
          <div class="mb-4">
            <label for="change-comment" class="block text-sm font-medium text-gray-300">Comment on Changes</label>
            <textarea id="change-comment" rows="4" class="mt-1 block w-full p-2 rounded-md bg-gray-600 border-gray-500 text-white text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Describe what changed in this version (e.g., added tenant signature, updated penalty clause)" required></textarea>
          </div>
          <div class="flex justify-end space-x-3">
            <button type="button" id="cancel-upload" class="px-4 py-2 bg-gray-600 text-white rounded-lg text-sm hover:bg-gray-700">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">Upload</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Main Content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Column: Metadata and Analysis -->
      <div class="lg:col-span-2 space-y-8">
        <!-- Document Metadata -->
        <div class="section-card p-6 bg-gray-800 rounded-xl">
          <h2 class="text-2xl font-bold text-white mb-4">Document Metadata</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
            <div>
              <p class="text-gray-400">File hash (SHA-256)</p>
              <p class="text-white">{{document.file_hash}}</p>
            </div>
            <br/>
            <div>
              <p class="text-gray-400">Cryptographic Verification</p>
              <p class="text-white">Mersenne Twister proves the hash</p>
            </div>
            <div>
              <p class="text-gray-400">File Size</p>
              <p class="text-white">2.3 MB</p>
            </div>
          </div>
        </div>

        <!-- Analysis Status -->
        <div class="section-card p-6 bg-gray-800 rounded-xl">
          <h2 class="text-2xl font-bold text-white mb-4">Analysis Status</h2>
          <div class="flex items-center space-x-4 mb-4">
            <span class="flex items-center text-green-400 px-4 py-2 bg-green-900 rounded-full">
              <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              Analysis Complete
            </span>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
            <div>
              <p class="text-gray-400">Started</p>
              <p class="text-white">{{document.analysis_started_at}}</p>
            </div>
            <div>
              <p class="text-gray-400">Completed</p>
              <p class="text-white">{{document.analysis_completed_at}}</p>
            </div>
            <div>
              <p class="text-gray-400">Analysis Cost</p>
              <p class="text-white">{{document.analysis_cost}} tokens</p>
            </div>
          </div>
        </div>

        <!-- Smart Summary -->
        <div class="section-card p-6 bg-gray-800 rounded-xl">
          <h2 class="text-2xl font-bold text-white mb-4">TL;DR</h2>
          <font color="red">XXX instead of "tento dokument .." do just "document"..</font>
          <p class="text-gray-300">{{document.ai_summary_long}}</p>
        </div>

        <!-- Analysis Criteria -->
        <div class="section-card p-6 bg-gray-800 rounded-xl">
          <h2 class="text-2xl font-bold text-white mb-4">Analysis Criteria</h2>
          <div class="p-4 bg-gray-700 rounded-lg">
            <div class="space-y-2">

              {{document.ai_analysis_criteria|safe}}

              <!-- Example -->
              <!-- <p class="text-gray-300 text-sm">
                The document was analyzed based on the AI prompt: "What to watch out for and thoroughly check 10 times in this type of document."</p>
                <ul class="list-disc list-inside text-gray-300 text-sm space-y-1">
                  <li>Completeness of signatures from all parties</li>
                  <li>Compliance with local leasing regulations</li>
                  <li>Clarity and fairness of termination clauses</li>
                  <li>Reasonableness of penalty terms for early termination</li>
                  <li>Renewal notice periods and conditions</li>
                  <li>Maintenance obligations for tenant and landlord</li>
                  <li>Payment schedules and late fee structures</li>
                  <li>Dispute resolution mechanisms</li>
                  <li>Property condition and inspection clauses</li>
                  <li>Insurance requirements for the property</li>
                </ul>
              <p class="text-gray-300 text-sm mt-2">These criteria ensure the document is legally sound, fair, and clear in its terms.</p> -->
            </div>
          </div>
        </div>

        <!-- Alerts & Actions -->
        <div class="section-card p-6 bg-gray-800 rounded-xl">
          <h2 class="text-2xl font-bold text-white mb-4">Alerts & Actions</h2>
          <div class="space-y-4">
            <!-- Expiry/Deadline Management -->
            <div class="alert-card action-required p-4 bg-gray-700 rounded-lg">
              <div class="flex items-center space-x-3">
                <svg class="h-6 w-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                  <p class="text-white font-medium">Expiry/Deadline Management</p>
                  <p class="text-gray-400 text-sm">Lease expires Apr 14, 2026. Renewal notice required by Mar 15, 2026.</p>
                  <p class="text-red-400 text-sm font-medium mt-1">Suggested Action: Schedule renewal notice for Mar 1, 2026.</p>
                </div>
              </div>
            </div>
            <!-- Compliance Alerts -->
            <div class="alert-card action-required p-4 bg-gray-700 rounded-lg">
              <div class="flex items-center space-x-3">
                <svg class="h-6 w-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <div>
                  <p class="text-white font-medium">Compliance Alerts</p>
                  <p class="text-gray-400 text-sm">Missing tenant signature detected.</p>
                  <p class="text-red-400 text-sm font-medium mt-1">Suggested Action: Contact tenant to obtain signature.</p>
                </div>
              </div>
            </div>
            <!-- Risk Analysis -->
            <div class="alert-card review-suggested p-4 bg-gray-700 rounded-lg">
              <div class="flex items-center space-x-3">
                <svg class="h-6 w-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <div>
                  <p class="text-white font-medium">Risk Analysis</p>
                  <p class="text-gray-400 text-sm">Early termination penalty is above industry norm.</p>
                  <p class="text-orange-400 text-sm font-medium mt-1">Suggested Action: Review penalty clause with legal team.</p>
                </div>
              </div>
            </div>


            <!-- Action Suggestions -->
            <div class="alert-card review-suggested p-4 bg-gray-700 rounded-lg">
              <div class="flex items-center space-x-3">
                <svg class="h-6 w-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <div>
                  <p class="text-white font-medium">Action Suggestions</p>
                  <p class="text-gray-400 text-sm">Negotiate penalty clause before renewal.</p>
                  <p class="text-blue-400 text-sm font-medium mt-1">Suggested Action: Discuss penalty terms with landlord.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Analysis Features and Insights -->
        <div class="section-card p-6 bg-gray-800 rounded-xl">
          <h2 class="text-2xl font-bold text-white mb-4">Analysis Features & Insights</h2>
          <div class="space-y-4">
            <!-- Expiry/Deadline Management -->
            <div class="feature-item flex items-center justify-between p-4 bg-gray-700 rounded-lg">
              <div class="flex items-center space-x-3">
                <svg class="h-6 w-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <div>
                  <p class="text-white font-medium">Expiry/Deadline Management</p>
                  <p class="text-gray-400 text-sm">Checks upcoming lease expiry dates and notifies when renewal or termination actions are due.</p>
                </div>
              </div>
              <span class="text-green-400 font-medium text-sm">Passed</span>
            </div>
            <!-- Compliance Alerts -->
            <div class="feature-item flex items-center justify-between p-4 bg-gray-700 rounded-lg">
              <div class="flex items-center space-x-3">
                <svg class="h-6 w-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <div>
                  <p class="text-white font-medium">Compliance Alerts</p>
                  <p class="text-gray-400 text-sm">Detects missing signatures, ensures required fields are completed, and flags non-compliant clauses.</p>
                </div>
              </div>
              <span class="text-green-400 font-medium text-sm">Passed</span>
            </div>
            <!-- Risk Analysis -->
            <div class="feature-item flex items-center justify-between p-4 bg-gray-700 rounded-lg">
              <div class="flex items-center space-x-3">
                <svg class="h-6 w-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <div>
                  <p class="text-white font-medium">Risk Analysis</p>
                  <p class="text-gray-400 text-sm">Evaluates financial and legal risks, including penalty terms and unusual contract clauses.</p>
                </div>
              </div>
              <span class="text-green-400 font-medium text-sm">Passed</span>
            </div>
            <!-- Beneficiary & Heir Auditing -->
            <div class="feature-item flex items-center justify-between p-4 bg-gray-700 rounded-lg">
              <div class="flex items-center space-x-3">
                <svg class="h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6"></path>
                </svg>
                <div>
                  <p class="text-white font-medium">Beneficiary & Heir Auditing</p>
                  <p class="text-gray-400 text-sm">Not applicable for this document type.</p>
                </div>
              </div>
              <span class="text-gray-400 font-medium text-sm">N/A</span>
            </div>
            <!-- Action Suggestions -->
            <div class="feature-item flex items-center justify-between p-4 bg-gray-700 rounded-lg">
              <div class="flex items-center space-x-3">
                <svg class="h-6 w-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <div>
                  <p class="text-white font-medium">Action Suggestions</p>
                  <p class="text-gray-400 text-sm">Offers recommended next steps based on analysis, such as negotiating terms or contacting stakeholders.</p>
                </div>
              </div>
              <span class="text-green-400 font-medium text-sm">Passed</span>
            </div>
          </div>
        </div>

        <!-- Metadata Details -->
        <div class="section-card p-6 bg-gray-800 rounded-xl font-mono border-l-4 border-green-500">
          <h2 class="text-2xl font-bold text-green-400 mb-4">Extraction Log</h2>
          <div class="grid grid-cols-1 text-sm text-gray-300">
            <div>
              <p class="text-gray-400">Enhanced Legacy Schema Mapping</p>
                  <br/>
                  {{document.ai_enterny_legacy_schema}}
              </pre>
              <br/>
              <br/>
              <font size="2">
              <a href="/data/mapping/docu-schemas_eterny.io.json" target="_blank" class="mapping-link">docu-schemas.json</a>
              </font>
            </div>
            <!-- Add additional metadata fields here as needed -->
          </div>
        </div>

        <!-- Change History -->
        <div class="section-card p-6 bg-gray-800 rounded-xl">
          <h2 class="text-2xl font-bold text-white mb-4">Change History</h2>
          <div class="p-4 bg-gray-700 rounded-lg">
            <ul class="timeline text-sm">
              <li class="timeline-item">
                <div class="space-y-1">
                  <div>
                    <span class="text-gray-300">Apr 16, 2025: </span>
                    <a href="https://eternyiq.com/docs/12345/versions/2025-04-16" class="text-blue-400 hover:underline">Updated with tenant signature</a>
                  </div>
                  <p class="text-gray-400">Comment: Added tenant signature to comply with compliance cabine requirements.</p>
                  <p class="text-gray-400">File Hash: a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6</p>
                  <p class="text-gray-400">File Size: 2.4 MB</p>
                </div>
              </li>
              <li class="timeline-item">
                <div class="space-y-1">
                  <div>
                    <span class="text-gray-300">Apr 15, 2025: </span>
                    <a href="https://eternyiq.com/docs/12345/versions/2025-04-15" class="text-blue-400 hover:underline">Initial document upload and analysis</a>
                  </div>
                  <p class="text-gray-400">Comment: Initial version of the rental agreement for analysis.</p>
                  <p class="text-gray-400">File Hash: e7d8c9b0a1f2e3d4c5b6a7d8c9e0f1a2</p>
                  <p class="text-gray-400">File Size: 2.3 MB</p>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Right Column: Document Preview -->
      <div class="lg:col-span-1">
        <div class="section-card p-6 bg-gray-800 rounded-xl sticky top-8">
          <h2 class="text-2xl font-bold text-white mb-4">Document Preview</h2>
          <div class="bg-gray-700 rounded-lg flex items-center justify-center preview-container">
            {% if document.file_preview %}
              <img id="preview-image" class="preview-image" src="/{{document.file_preview}}" alt="Document Preview">
            {% else %}
              <p class="text-gray-400">Preview Not Available</p>
            {% endif %}
          </div>
          <div class="mt-4 flex justify-between">
            <button id="view-full-document" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm">View Full Document</button>
            <a href="/data/uploads/{{document.customer_id}}/{{document.filename|urlencode}}" download class="px-4 py-2 bg-gray-600 text-white rounded-lg text-sm">Download</a>
          </div>
        </div>

        <!-- Full-Screen Document Modal -->
        <div id="document-modal" class="document-modal">
          <div class="document-modal-content">
            {% if document.file_preview %}
              <img src="/{{document.file_preview}}" alt="Full Document Preview">
            {% else %}
              <p class="text-gray-400 text-center">Full Document Not Available</p>
            {% endif %}
            <div id="document-modal-close" class="document-modal-close">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat with Document -->
    <div class="chat-container minimized" id="chat-container">
      <div class="chat-header" id="chat-header">
        <h3 class="text-lg font-semibold text-white">Chat with this Document</h3>
        <svg id="chat-toggle" class="chat-toggle minimized h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </div>
      <div class="chat-content">
        <form id="chat-form">
          <div class="chat-input">
            <input type="text" id="chat-question" placeholder="Ask questions about this document..." required>
            <button type="submit">Ask</button>
          </div>
        </form>
        <div class="chat-dialog">
          <div class="chat-dialog-question">
            <svg class="h-5 w-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <p>What is the penalty for early termination of the lease?</p>
          </div>
          <div class="chat-dialog-answer">
            <svg class="h-5 w-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5v-2a2 2 0 012-2h10a2 2 0 012 2v2h-4m-6 0h.01M12 16h.01"></path>
            </svg>
            <p>The penalty for early termination is a fee equivalent to two months' rent, as specified in Section 4.3 of the agreement. Additionally, the tenant must provide a 60-day written notice before the intended termination date. Failure to comply with the notice period may trigger an extra charge of 50% of one month's rent, as outlined in the penalty clause.</p>
          </div>
          <br/>
          <div class="chat-dialog-question">
            <svg class="h-5 w-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <p>What are the maintenance responsibilities of the tenant?</p>
          </div>
          <div class="chat-dialog-answer">
            <svg class="h-5 w-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5v-2a2 2 0 012-2h10a2 2 0 012 2v2h-4m-6 0h.01M12 16h.01"></path>
            </svg>
            <p>The tenant is responsible for routine maintenance, including cleaning common areas, replacing light bulbs, and addressing minor repairs such as leaky faucets, as outlined in Section 5.2 of the agreement. For major structural issues, the landlord retains responsibility. The tenant must report any significant damage within seven days of occurrence to avoid liability.</p>
          </div>
          <br/>
          <div class="chat-dialog-question">
            <svg class="h-5 w-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <p>Is subletting permitted under the lease?</p>
          </div>
          <div class="chat-dialog-answer">
            <svg class="h-5 w-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5v-2a2 2 0 012-2h10a2 2 0 012 2v2h-4m-6 0h.01M12 16h.01"></path>
            </svg>
            <p>Subletting is prohibited without prior written consent from the landlord, as stated in Section 6.4. If the tenant wishes to sublet, they must submit a written request at least 30 days in advance. The landlord has 14 days to approve or deny the request, and unauthorized subletting may result in termination of the lease.</p>
          </div>
          <br/>
          <div class="chat-dialog-question">
            <svg class="h-5 w-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <p>What are the maintenance responsibilities of the tenant?</p>
          </div>
          <div class="chat-dialog-answer">
            <svg class="h-5 w-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5v-2a2 2 0 012-2h10a2 2 0 012 2v2h-4m-6 0h.01M12 16h.01"></path>
            </svg>
            <p>The tenant is responsible for routine maintenance, including cleaning common areas, replacing light bulbs, and addressing minor repairs such as leaky faucets, as outlined in Section 5.2 of the agreement. For major structural issues, the landlord retains responsibility. The tenant must report any significant damage within seven days of occurrence to avoid liability.</p>
          </div>
          <br/>
          <div class="chat-dialog-question">
            <svg class="h-5 w-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <p>Is subletting permitted under the lease?</p>
          </div>
          <div class="chat-dialog-answer">
            <svg class="h-5 w-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5v-2a2 2 0 012-2h10a2 2 0 012 2v2h-4m-6 0h.01M12 16h.01"></path>
            </svg>
            <p>Subletting is prohibited without prior written consent from the landlord, as stated in Section 6.4. If the tenant wishes to sublet, they must submit a written request at least 30 days in advance. The landlord has 14 days to approve or deny the request, and unauthorized subletting may result in termination of the lease.</p>
          </div>
          <br/>
          <div class="chat-dialog-question">
            <svg class="h-5 w-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <p>What are the maintenance responsibilities of the tenant?</p>
          </div>
          <div class="chat-dialog-answer">
            <svg class="h-5 w-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5v-2a2 2 0 012-2h10a2 2 0 012 2v2h-4m-6 0h.01M12 16h.01"></path>
            </svg>
            <p>The tenant is responsible for routine maintenance, including cleaning common areas, replacing light bulbs, and addressing minor repairs such as leaky faucets, as outlined in Section 5.2 of the agreement. For major structural issues, the landlord retains responsibility. The tenant must report any significant damage within seven days of occurrence to avoid liability.</p>
          </div>
          <br/>
          <div class="chat-dialog-question">
            <svg class="h-5 w-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <p>Is subletting permitted under the lease?</p>
          </div>
          <div class="chat-dialog-answer">
            <svg class="h-5 w-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5v-2a2 2 0 012-2h10a2 2 0 012 2v2h-4m-6 0h.01M12 16h.01"></path>
            </svg>
            <p>Subletting is prohibited without prior written consent from the landlord, as stated in Section 6.4. If the tenant wishes to sublet, they must submit a written request at least 30 days in advance. The landlord has 14 days to approve or deny the request, and unauthorized subletting may result in termination of the lease.</p>
          </div>
          <br/>
          <div class="chat-dialog-question">
            <svg class="h-5 w-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <p>What are the maintenance responsibilities of the tenant?</p>
          </div>
          <div class="chat-dialog-answer">
            <svg class="h-5 w-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5v-2a2 2 0 012-2h10a2 2 0 012 2v2h-4m-6 0h.01M12 16h.01"></path>
            </svg>
            <p>The tenant is responsible for routine maintenance, including cleaning common areas, replacing light bulbs, and addressing minor repairs such as leaky faucets, as outlined in Section 5.2 of the agreement. For major structural issues, the landlord retains responsibility. The tenant must report any significant damage within seven days of occurrence to avoid liability.</p>
          </div>
          <br/>
          <div class="chat-dialog-question">
            <svg class="h-5 w-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <p>Is subletting permitted under the lease?</p>
          </div>
          <div class="chat-dialog-answer">
            <svg class="h-5 w-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5v-2a2 2 0 012-2h10a2 2 0 012 2v2h-4m-6 0h.01M12 16h.01"></path>
            </svg>
            <p>Subletting is prohibited without prior written consent from the landlord, as stated in Section 6.4. If the tenant wishes to sublet, they must submit a written request at least 30 days in advance. The landlord has 14 days to approve or deny the request, and unauthorized subletting may result in termination of the lease.</p>
          </div>
          <br/>
          <div class="chat-dialog-question">
            <svg class="h-5 w-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <p>What are the maintenance responsibilities of the tenant?</p>
          </div>
          <div class="chat-dialog-answer">
            <svg class="h-5 w-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5v-2a2 2 0 012-2h10a2 2 0 012 2v2h-4m-6 0h.01M12 16h.01"></path>
            </svg>
            <p>The tenant is responsible for routine maintenance, including cleaning common areas, replacing light bulbs, and addressing minor repairs such as leaky faucets, as outlined in Section 5.2 of the agreement. For major structural issues, the landlord retains responsibility. The tenant must report any significant damage within seven days of occurrence to avoid liability.</p>
          </div>
          <br/>
          <div class="chat-dialog-question">
            <svg class="h-5 w-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <p>Is subletting permitted under the lease?</p>
          </div>
          <div class="chat-dialog-answer">
            <svg class="h-5 w-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5v-2a2 2 0 012-2h10a2 2 0 012 2v2h-4m-6 0h.01M12 16h.01"></path>
            </svg>
            <p>Subletting is prohibited without prior written consent from the landlord, as stated in Section 6.4. If the tenant wishes to sublet, they must submit a written request at least 30 days in advance. The landlord has 14 days to approve or deny the request, and unauthorized subletting may result in termination of the lease.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  const uploadButton = document.getElementById('upload-new-version');
  const uploadModal = document.getElementById('upload-modal');
  const closeModal = document.getElementById('close-modal');
  const cancelUpload = document.getElementById('cancel-upload');
  const uploadForm = document.getElementById('upload-form');
  const chatForm = document.getElementById('chat-form');
  const chatContainer = document.getElementById('chat-container');
  const chatHeader = document.getElementById('chat-header');
  const chatToggle = document.getElementById('chat-toggle');
  const viewFullDocumentButton = document.getElementById('view-full-document');
  const previewImage = document.getElementById('preview-image');
  const documentModal = document.getElementById('document-modal');
  const documentModalClose = document.getElementById('document-modal-close');

  // Upload Modal Logic
  uploadButton.addEventListener('click', () => {
    uploadModal.style.display = 'flex';
  });

  closeModal.addEventListener('click', () => {
    uploadModal.style.display = 'none';
  });

  cancelUpload.addEventListener('click', () => {
    uploadModal.style.display = 'none';
  });

  uploadModal.addEventListener('click', (e) => {
    if (e.target === uploadModal) {
      uploadModal.style.display = 'none';
    }
  });

  uploadForm.addEventListener('submit', (e) => {
    e.preventDefault();
    // Placeholder for form submission logic
    alert('Document uploaded successfully!'); // Replace with actual upload logic
    uploadModal.style.display = 'none';
    uploadForm.reset();
  });

  // Chat Logic
  chatForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const question = document.getElementById('chat-question').value;
    // Placeholder for RAG-based chat logic
    alert(`Question submitted: ${question}`); // Replace with actual RAG implementation
    chatForm.reset();
  });

  chatHeader.addEventListener('click', () => {
    if (chatContainer.classList.contains('maximized')) {
      chatContainer.classList.remove('maximized');
      chatContainer.classList.add('minimized');
      chatToggle.classList.add('minimized');
    } else {
      chatContainer.classList.remove('minimized');
      chatContainer.classList.add('maximized');
      chatToggle.classList.remove('minimized');
    }
  });

  // Document Modal Logic
  viewFullDocumentButton.addEventListener('click', () => {
    documentModal.style.display = 'flex';
  });

  if (previewImage) {
    previewImage.addEventListener('click', () => {
      documentModal.style.display = 'flex';
    });
  }

  documentModalClose.addEventListener('click', () => {
    documentModal.style.display = 'none';
  });

  documentModal.addEventListener('click', (e) => {
    if (e.target === documentModal) {
      documentModal.style.display = 'none';
    }
  });

  // Download Dropdown Fix
  document.querySelectorAll('.dropdown-item a').forEach(link => {
    link.addEventListener('click', (e) => {
      console.log('Download link clicked:', link.href);
      // Ensure default behavior is not prevented
      if (!link.href) {
        e.preventDefault();
        console.error('Invalid href for download link');
      }
    });
  });

  // Print Dropdown Item
  const printItem = document.querySelector('.dropdown-item.print-item');
  if (printItem) {
    printItem.addEventListener('click', () => {
      window.print();
    });
  }

  // Copy Link to Clipboard with Visual Confirmation (updated logic)
  const copyLinkItem = document.getElementById('copy-link');
  if (copyLinkItem) {
    copyLinkItem.addEventListener('click', async (e) => {
      e.preventDefault();
      const link = window.location.href;
      const originalText = copyLinkItem.textContent;

      async function copyText(text) {
        if (navigator.clipboard && window.isSecureContext) {
          // Modern secure clipboard API
          return navigator.clipboard.writeText(text);
        } else {
          // Fallback for insecure contexts
          const textArea = document.createElement("textarea");
          textArea.value = text;
          textArea.style.position = "fixed";
          textArea.style.top = "-9999px";
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          try {
            document.execCommand('copy');
          } catch (err) {
            console.error('Clipboard fallback failed:', err);
          }
          document.body.removeChild(textArea);
        }
      }

      try {
        await copyText(link);
        copyLinkItem.textContent = 'Link copied!';
      } catch (err) {
        console.error('Failed to copy link:', err);
        copyLinkItem.textContent = 'Copy failed';
      } finally {
        setTimeout(() => {
          copyLinkItem.textContent = originalText;
        }, 2000);
      }
    });
  }
</script>
{% endblock %}
